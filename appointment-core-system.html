<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>預約管理系統 - FLOS曜診所</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="flos-style.css">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        .appointment-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .appointment-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .appointment-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .appointment-header p {
            color: #aaa;
            font-size: 1.1rem;
        }

        /* 控制面板 */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .control-card {
            background: linear-gradient(145deg, rgba(42, 42, 42, 0.9), rgba(26, 26, 26, 0.9));
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .control-card h3 {
            color: #d4af37;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #dc3545;
        }

        .status-dot.syncing {
            background: #ffc107;
        }

        /* 月份大表 */
        .calendar-container {
            background: linear-gradient(145deg, rgba(42, 42, 42, 0.9), rgba(26, 26, 26, 0.9));
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-bottom: 2rem;
        }

        .calendar-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-btn {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            border: none;
            color: #1a1a1a;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        .current-month {
            font-size: 1.5rem;
            font-weight: bold;
            color: #d4af37;
            min-width: 200px;
            text-align: center;
        }

        .view-controls {
            display: flex;
            gap: 0.5rem;
        }

        .view-btn {
            background: rgba(42, 42, 42, 0.8);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            color: #1a1a1a;
        }

        /* 日曆表格 */
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .calendar-table th {
            background: rgba(26, 26, 26, 0.8);
            color: #d4af37;
            padding: 1rem;
            text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.2);
            font-weight: bold;
        }

        .calendar-table td {
            height: 120px;
            width: 14.28%;
            border: 1px solid rgba(212, 175, 55, 0.2);
            vertical-align: top;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-table td:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .date-number {
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }

        .date-number.other-month {
            color: #666;
        }

        .date-number.today {
            background: #d4af37;
            color: #1a1a1a;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .appointment-item {
            background: rgba(212, 175, 55, 0.2);
            border-left: 3px solid #d4af37;
            padding: 0.2rem 0.5rem;
            margin-bottom: 0.2rem;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .appointment-item:hover {
            background: rgba(212, 175, 55, 0.4);
        }

        .appointment-item.liu-doctor {
            border-left-color: #6f42c1;
            background: rgba(111, 66, 193, 0.2);
        }

        .appointment-item.yao-clinic {
            border-left-color: #20c997;
            background: rgba(32, 201, 151, 0.2);
        }

        .appointment-item.staff-referral {
            border-left-color: #0dcaf0;
            background: rgba(13, 202, 240, 0.2);
        }

        /* 時段表格檢視 */
        .time-slot-view {
            display: none;
            overflow-x: auto;
        }

        .time-slot-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
        }

        .time-slot-table th {
            background: rgba(26, 26, 26, 0.8);
            color: #d4af37;
            padding: 0.8rem;
            text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.2);
            font-size: 0.9rem;
        }

        .time-slot-table td {
            height: 50px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .time-slot-table td:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .time-slot {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .time-slot.available {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .time-slot.partial {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .time-slot.full {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .time-slot.blocked {
            background: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }

        /* 新增預約表單 */
        .appointment-form {
            background: linear-gradient(145deg, rgba(42, 42, 42, 0.9), rgba(26, 26, 26, 0.9));
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            color: #d4af37;
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            border-radius: 8px;
            padding: 0.75rem;
            width: 100%;
        }

        .form-control:focus {
            border-color: #d4af37;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            outline: none;
        }

        .btn-appointment {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            border: none;
            color: #1a1a1a;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-appointment:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        /* 統計資訊 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(42, 42, 42, 0.9), rgba(26, 26, 26, 0.9));
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #aaa;
            font-size: 0.9rem;
        }

        /* 右下角機器人 */
        .ai-assistant {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #d4af37, #b8860b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .ai-assistant:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.6);
        }

        .ai-assistant i {
            font-size: 1.5rem;
            color: #1a1a1a;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .appointment-container {
                padding: 1rem;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .calendar-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .calendar-table td {
                height: 80px;
                font-size: 0.8rem;
            }
            
            .appointment-item {
                font-size: 0.7rem;
                padding: 0.1rem 0.3rem;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-clinic-medical me-2"></i>
                FLOS曜診所 | 預約管理系統
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">首頁</a></li>
                    <li class="nav-item"><a class="nav-link active" href="appointment-core-system.html">預約</a></li>
                    <li class="nav-item"><a class="nav-link" href="electronic-medical-records.html">病歷</a></li>
                    <li class="nav-item"><a class="nav-link" href="treatment-management.html">療程</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="appointment-container">
        <!-- 頁面標題 -->
        <div class="appointment-header">
            <h1><i class="fas fa-calendar-check me-2"></i>FLOS曜診所預約管理系統</h1>
            <p>統一預約管理 | 15分鐘時段制 | 智能衝突檢測</p>
        </div>

        <!-- 統計資訊 -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="todayAppointments">0</div>
                <div class="stat-label">今日預約</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="weekAppointments">0</div>
                <div class="stat-label">本週預約</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthAppointments">0</div>
                <div class="stat-label">本月預約</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="conflictWarnings">0</div>
                <div class="stat-label">衝突警告</div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="control-card">
                <h3><i class="fas fa-sync me-2"></i>Google Calendar 同步</h3>
                <div class="sync-status">
                    <div class="status-dot" id="googleStatus"></div>
                    <span id="googleStatusText">已連接</span>
                </div>
                <button class="btn btn-appointment btn-sm mt-2" onclick="syncGoogleCalendar()">
                    <i class="fas fa-sync me-1"></i>立即同步
                </button>
            </div>

            <div class="control-card">
                <h3><i class="fas fa-line me-2"></i>LINE Bot 狀態</h3>
                <div class="sync-status">
                    <div class="status-dot" id="lineStatus"></div>
                    <span>劉道玄帳號：已連接</span>
                </div>
                <div class="sync-status">
                    <div class="status-dot disconnected" id="yaoStatus"></div>
                    <span>曜診所帳號：待設定</span>
                </div>
            </div>

            <div class="control-card">
                <h3><i class="fas fa-cog me-2"></i>系統設定</h3>
                <div class="mb-2">
                    <label>每時段人數限制：</label>
                    <select class="form-control" id="slotLimit" onchange="updateSlotLimit()">
                        <option value="1">1人</option>
                        <option value="2" selected>2人</option>
                        <option value="3">3人</option>
                        <option value="4">4人</option>
                        <option value="5">5人</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label>滿額封鎖時間：</label>
                    <select class="form-control" id="blockTime" onchange="updateBlockTime()">
                        <option value="15">15分鐘</option>
                        <option value="30" selected>30分鐘</option>
                        <option value="60">60分鐘</option>
                        <option value="120">120分鐘</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 月份大表 -->
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="previousMonth()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="current-month" id="currentMonth">2025年9月</div>
                    <button class="nav-btn" onclick="nextMonth()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="view-controls">
                    <button class="view-btn active" onclick="switchView('month')">月檢視</button>
                    <button class="view-btn" onclick="switchView('week')">週檢視</button>
                    <button class="view-btn" onclick="switchView('day')">日檢視</button>
                </div>
            </div>

            <!-- 月檢視 -->
            <div id="monthView" class="calendar-view">
                <table class="calendar-table">
                    <thead>
                        <tr>
                            <th>週日</th>
                            <th>週一</th>
                            <th>週二</th>
                            <th>週三</th>
                            <th>週四</th>
                            <th>週五</th>
                            <th>週六</th>
                        </tr>
                    </thead>
                    <tbody id="calendarBody">
                        <!-- 日曆內容將由JavaScript生成 -->
                    </tbody>
                </table>
            </div>

            <!-- 時段檢視 -->
            <div id="timeSlotView" class="time-slot-view">
                <table class="time-slot-table">
                    <thead>
                        <tr>
                            <th>時間</th>
                            <th>週一</th>
                            <th>週二</th>
                            <th>週三</th>
                            <th>週四</th>
                            <th>週五</th>
                            <th>週六</th>
                            <th>週日</th>
                        </tr>
                    </thead>
                    <tbody id="timeSlotBody">
                        <!-- 時段內容將由JavaScript生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 新增預約表單 -->
        <div class="appointment-form" id="appointmentForm" style="display: none;">
            <h3><i class="fas fa-plus me-2"></i>新增預約</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">客戶姓名</label>
                        <input type="text" class="form-control" id="customerName" placeholder="請輸入客戶姓名">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">聯絡電話</label>
                        <input type="tel" class="form-control" id="customerPhone" placeholder="請輸入聯絡電話">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">預約日期</label>
                        <input type="date" class="form-control" id="appointmentDate">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">預約時間</label>
                        <select class="form-control" id="appointmentTime">
                            <!-- 時間選項將由JavaScript生成 -->
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">預約來源</label>
                        <select class="form-control" id="appointmentSource">
                            <option value="phone">電話預約</option>
                            <option value="line">LINE預約</option>
                            <option value="walk-in">現場預約</option>
                            <option value="staff">員工推薦</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">療程項目</label>
                <select class="form-control" id="treatmentType">
                    <option value="">請選擇療程項目</option>
                    <option value="syndeo">Syndeo海菲秀</option>
                    <option value="jetpeel">JetPeel潔比爾</option>
                    <option value="seyo">SEYO水光儀</option>
                    <option value="inmode">InMode LIFT鑽石超塑</option>
                    <option value="emsculpt">Emsculpt NEO熱磁減脂</option>
                    <option value="density">DENSITY無雙電波</option>
                    <option value="ultraformer">Ultraformer MPT海芙音波</option>
                    <option value="pico">Discovery Pico探索皮秒</option>
                    <option value="laser">Pro U亞歷山大除毛</option>
                    <option value="botox">保妥適肉毒桿菌</option>
                    <option value="juvederm">Juvederm喬雅登玻尿酸</option>
                    <option value="iv">營養點滴</option>
                    <option value="pre">PRE自體修復</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">備註</label>
                <textarea class="form-control" id="appointmentNotes" rows="3" placeholder="請輸入備註資訊"></textarea>
            </div>
            <div class="d-flex gap-2">
                <button class="btn-appointment" onclick="saveAppointment()">
                    <i class="fas fa-save me-1"></i>儲存預約
                </button>
                <button class="btn btn-secondary" onclick="cancelAppointment()">
                    <i class="fas fa-times me-1"></i>取消
                </button>
            </div>
        </div>
    </div>

    <!-- 右下角AI助理 -->
        <i class="fas fa-robot"></i>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全域變數
        let currentDate = new Date();
        let currentView = 'month';
        let appointments = [];
        let slotLimit = 2;
        let blockTime = 30;
        let currentUserRole = 'employee';

        // Google Calendar API 配置
        const GOOGLE_CLIENT_ID = '519705406951-rbdhk7l6et1vd1u83nv49hn1f53bjski.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyBqJ8s-B0kNFfpjcbDBDCDjKjJDNlmK8ykGYKWKzmaDT_rEjXoyZi7Y22feHOSXTlKTdZFs3kd1Hxw59MgilIVJzFKg0tKJOKK1xv_ZTZ-oaUuNmUdui_QIbHwNorVo6BW0yHo7eG7vdJJvY9_wxtsfQdB04t89_1O_w1cDnyilFU';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar';

        let gapi;
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeCalendar();
            generateTimeOptions();
            loadAppointments();
            updateStatistics();
            
            // 檢查權限狀態
            checkUserPermissions();
        });

        // 檢查用戶權限
        function checkUserPermissions() {
            // 從localStorage或其他地方獲取當前用戶角色
            const savedRole = localStorage.getItem('flos-current-role') || 'employee';
            currentUserRole = savedRole;
        }

        // 初始化日曆
        function initializeCalendar() {
            updateCalendarHeader();
            generateCalendar();
        }

        // 更新日曆標題
        function updateCalendarHeader() {
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            document.getElementById('currentMonth').textContent = 
                `${currentDate.getFullYear()}年${monthNames[currentDate.getMonth()]}`;
        }

        // 生成日曆
        function generateCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 清空現有內容
            calendarBody.innerHTML = '';
            
            // 獲取月份第一天和最後一天
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // 生成6週的日曆
            for (let week = 0; week < 6; week++) {
                const row = document.createElement('tr');
                
                for (let day = 0; day < 7; day++) {
                    const cell = document.createElement('td');
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const dateNumber = document.createElement('div');
                    dateNumber.className = 'date-number';
                    dateNumber.textContent = cellDate.getDate();
                    
                    // 標記不同月份的日期
                    if (cellDate.getMonth() !== month) {
                        dateNumber.classList.add('other-month');
                    }
                    
                    // 標記今天
                    const today = new Date();
                    if (cellDate.toDateString() === today.toDateString()) {
                        dateNumber.classList.add('today');
                    }
                    
                    cell.appendChild(dateNumber);
                    
                    // 添加預約項目
                    const dayAppointments = getAppointmentsForDate(cellDate);
                    dayAppointments.forEach(appointment => {
                        const appointmentDiv = document.createElement('div');
                        appointmentDiv.className = `appointment-item ${appointment.source}`;
                        appointmentDiv.textContent = `${appointment.time} ${appointment.customer}`;
                        appointmentDiv.onclick = () => editAppointment(appointment.id);
                        cell.appendChild(appointmentDiv);
                    });
                    
                    // 添加點擊事件
                    cell.onclick = () => selectDate(cellDate);
                    
                    row.appendChild(cell);
                }
                
                calendarBody.appendChild(row);
            }
        }

        // 獲取指定日期的預約
        function getAppointmentsForDate(date) {
            return appointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate.toDateString() === date.toDateString();
            });
        }

        // 選擇日期
        function selectDate(date) {
            document.getElementById('appointmentDate').value = date.toISOString().split('T')[0];
            showAppointmentForm();
        }

        // 顯示預約表單
        function showAppointmentForm() {
            document.getElementById('appointmentForm').style.display = 'block';
            document.getElementById('appointmentForm').scrollIntoView({ behavior: 'smooth' });
        }

        // 隱藏預約表單
        function cancelAppointment() {
            document.getElementById('appointmentForm').style.display = 'none';
            clearForm();
        }

        // 清空表單
        function clearForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('appointmentDate').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentSource').value = 'phone';
            document.getElementById('treatmentType').value = '';
            document.getElementById('appointmentNotes').value = '';
        }

        // 生成時間選項
        function generateTimeOptions() {
            const timeSelect = document.getElementById('appointmentTime');
            timeSelect.innerHTML = '';
            
            // 營業時間：09:00-18:00，每15分鐘一個時段
            for (let hour = 9; hour < 18; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = timeString;
                    option.textContent = timeString;
                    timeSelect.appendChild(option);
                }
            }
        }

        // 儲存預約
        function saveAppointment() {
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const appointmentDate = document.getElementById('appointmentDate').value;
            const appointmentTime = document.getElementById('appointmentTime').value;
            const appointmentSource = document.getElementById('appointmentSource').value;
            const treatmentType = document.getElementById('treatmentType').value;
            const appointmentNotes = document.getElementById('appointmentNotes').value;

            if (!customerName || !customerPhone || !appointmentDate || !appointmentTime) {
                showNotification('請填寫所有必填欄位', 'error');
                return;
            }

            // 檢查時段衝突
            if (checkTimeSlotConflict(appointmentDate, appointmentTime)) {
                if (!confirm('此時段已有預約，確定要繼續嗎？')) {
                    return;
                }
            }

            const newAppointment = {
                id: Date.now(),
                customer: customerName,
                phone: customerPhone,
                date: appointmentDate,
                time: appointmentTime,
                source: appointmentSource,
                treatment: treatmentType,
                notes: appointmentNotes,
                status: 'confirmed'
            };

            appointments.push(newAppointment);
            saveAppointmentsToStorage();
            generateCalendar();
            updateStatistics();
            cancelAppointment();
            
            showNotification('預約已成功建立', 'success');
            
            // 同步到Google Calendar
            syncToGoogleCalendar(newAppointment);
        }

        // 檢查時段衝突
        function checkTimeSlotConflict(date, time) {
            const conflictCount = appointments.filter(apt => 
                apt.date === date && apt.time === time
            ).length;
            
            return conflictCount >= slotLimit;
        }

        // 載入預約資料
        function loadAppointments() {
            const saved = localStorage.getItem('flos-appointments');
            if (saved) {
                appointments = JSON.parse(saved);
            }
            
            // 載入夯客預約資料
            loadHotcakeAppointments();
        }

        // 載入夯客預約資料
        function loadHotcakeAppointments() {
            // 這裡會串接夯客API或LIFF來獲取預約資料
            // 暫時使用模擬資料
            const hotcakeAppointments = [
                {
                    id: 'hotcake_001',
                    customer: '王小美',
                    phone: '0912345678',
                    date: '2025-09-26',
                    time: '10:00',
                    source: 'liu-doctor',
                    treatment: 'syndeo',
                    notes: '夯客會員預約',
                    status: 'confirmed'
                }
            ];
            
            // 合併夯客預約到主預約列表
            hotcakeAppointments.forEach(apt => {
                if (!appointments.find(existing => existing.id === apt.id)) {
                    appointments.push(apt);
                }
            });
        }

        // 儲存預約到本地存儲
        function saveAppointmentsToStorage() {
            localStorage.setItem('flos-appointments', JSON.stringify(appointments));
        }

        // 更新統計資訊
        function updateStatistics() {
            const today = new Date().toISOString().split('T')[0];
            const thisWeek = getWeekRange(new Date());
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();

            const todayCount = appointments.filter(apt => apt.date === today).length;
            const weekCount = appointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate >= thisWeek.start && aptDate <= thisWeek.end;
            }).length;
            const monthCount = appointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate.getMonth() === thisMonth && aptDate.getFullYear() === thisYear;
            }).length;

            document.getElementById('todayAppointments').textContent = todayCount;
            document.getElementById('weekAppointments').textContent = weekCount;
            document.getElementById('monthAppointments').textContent = monthCount;
            document.getElementById('conflictWarnings').textContent = '0'; // 實際應計算衝突數量
        }

        // 獲取週範圍
        function getWeekRange(date) {
            const start = new Date(date);
            start.setDate(date.getDate() - date.getDay());
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            return { start, end };
        }

        // 切換檢視模式
        function switchView(view) {
            currentView = view;
            
            // 更新按鈕狀態
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 切換檢視
            if (view === 'month') {
                document.getElementById('monthView').style.display = 'block';
                document.getElementById('timeSlotView').style.display = 'none';
            } else if (view === 'week') {
                document.getElementById('monthView').style.display = 'none';
                document.getElementById('timeSlotView').style.display = 'block';
                generateTimeSlotView();
            }
        }

        // 生成時段檢視
        function generateTimeSlotView() {
            const timeSlotBody = document.getElementById('timeSlotBody');
            timeSlotBody.innerHTML = '';
            
            // 生成時段行
            for (let hour = 9; hour < 18; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    const row = document.createElement('tr');
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    
                    // 時間欄
                    const timeCell = document.createElement('td');
                    timeCell.textContent = timeString;
                    timeCell.style.fontWeight = 'bold';
                    row.appendChild(timeCell);
                    
                    // 週一到週日
                    for (let day = 1; day <= 7; day++) {
                        const cell = document.createElement('td');
                        const slotDiv = document.createElement('div');
                        slotDiv.className = 'time-slot available';
                        slotDiv.textContent = '可預約';
                        slotDiv.onclick = () => selectTimeSlot(day, timeString);
                        cell.appendChild(slotDiv);
                        row.appendChild(cell);
                    }
                    
                    timeSlotBody.appendChild(row);
                }
            }
        }

        // 選擇時段
        function selectTimeSlot(day, time) {
            // 計算日期
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay() + day);
            
            document.getElementById('appointmentDate').value = weekStart.toISOString().split('T')[0];
            document.getElementById('appointmentTime').value = time;
            showAppointmentForm();
        }

        // 上一個月
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendarHeader();
            generateCalendar();
        }

        // 下一個月
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendarHeader();
            generateCalendar();
        }

        // 同步Google Calendar
        function syncGoogleCalendar() {
            showNotification('正在同步Google Calendar...', 'info');
            
            // 模擬同步過程
            setTimeout(() => {
                showNotification('Google Calendar同步完成', 'success');
                document.getElementById('googleStatus').className = 'status-dot';
                document.getElementById('googleStatusText').textContent = '已同步';
            }, 2000);
        }

        // 同步到Google Calendar
        function syncToGoogleCalendar(appointment) {
            // 這裡會實際調用Google Calendar API
            console.log('同步預約到Google Calendar:', appointment);
        }

        // 更新時段限制
        function updateSlotLimit() {
            slotLimit = parseInt(document.getElementById('slotLimit').value);
            showNotification(`時段人數限制已更新為${slotLimit}人`, 'info');
        }

        // 更新封鎖時間
        function updateBlockTime() {
            blockTime = parseInt(document.getElementById('blockTime').value);
            showNotification(`滿額封鎖時間已更新為${blockTime}分鐘`, 'info');
        }

        // 切換AI助理
        function toggleAIAssistant() {
            // 檢查權限
            if (currentUserRole === 'employee') {
                const password = prompt('請輸入管理員密鑰：');
                if (password !== 'liu_daoxuan_admin_2024') {
                    showNotification('密鑰錯誤', 'error');
                    return;
                }
            }
            
            showNotification('AI智能助理已啟用', 'success');
            // 這裡可以開啟AI助理面板
        }

        // 通知系統
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107',
                'info': '#d4af37'
            };
            
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: rgba(42, 42, 42, 0.95);
                border: 2px solid ${colors[type] || colors.info};
                border-radius: 10px;
                padding: 1rem 1.5rem;
                color: ${colors[type] || colors.info};
                z-index: 3000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                max-width: 300px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>
